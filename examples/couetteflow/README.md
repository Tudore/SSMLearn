This is a preview of the livescript `romRe146.mlx` (see also the other ones present in the folder).

# Modeling the transition between exact coherent states of Plane Couette flow
# Reduced order model near a limit cycle

*B. Kaszás, M. Cenedese*

We consider the problem of plane Couette flow, that is, flow between two infinite planes moving in the opposite direction. 

![image_0.png
](README_images/image_0.png
)

> Streamwise velocity of the limit cycle.

  

The calculations were carried out at $\textrm{Re}=146$ in the Nagata-cell, defined as $\Omega =\left\lbrack 0,L_x \right\rbrack \times \;\left\lbrack -1,1\right\rbrack \times \;\left\lbrack 0,L_z \right\rbrack =\left\lbrack 0,5\pi /2\right\rbrack \times \;\left\lbrack -1,1\right\rbrack \times \;\left\lbrack 0,4\pi /3\right\rbrack$ as in [1]. We restrict all calculations to the invariant subspace of the isotropy subgroup of the Nagata-equilibria. This group is generated by the so-called shift-reflect and shift-rotate symmetries [2].

  

These computations are described in the manuscript [3]. We take velocity fields generated by [Channelflow](https://channelflow.ch) [4] and build reduced order models which are able to capture the transition between dynamically relevant coherent states. We note that the results presented in the manuscript were obtained by processing the full velocity fields, which had resolution $\left(N_x ,N_y ,N_z \right)=\left(32,35,32\right)$. In this notebook, simply to avoid having to upload large volumes of data, we use a compressed representation of the full flow fields by taking the projection to the first 20 PCA modes. The full data is available from the authors upon request. 

We use data describing the transition between the three coexisting fixed points (or equilibria).  We denote the velocity field by $\mathbf{u}\left(\mathit{\mathbf{x}},t\right)=\left\lbrack \begin{array}{c}
u\left(x,y,z,t\right)\\
v\left(x,y,z,t\right)\\
w\left(x,y,z,t\right)
\end{array}\right\rbrack$ .

The laminar base state at the origin $\mathbf{u}\left(\mathit{\mathbf{x}},t\right)=\left(y,0,0\right)$ is a stable fixed point in this flow. The lower and upper branch fixed points appear in a saddle-node bifurcation at $\textrm{Re}=134\ldotp 50$. The lower branch is an unstable fixed point, while the upper branch is stable. Shortly after the bifurcation, two of the least stable real eigenvalues of the upper branch collide, resulting in a complex conjugate pair of eigenvalues. As a result, the subspace corresponding to the least stable eigenvalue becomes two-dimensional at the upper branch. At $\textrm{Re}=145$, the upper branch loses stability and a stable limit cycle is born out of a Hopf bifurcation. We now focus on the regime shortly after the Hopf, at $\textrm{Re}=146$. 

In this parameter regime, the theory of spectral submanifolds [5] tells us that there exists a unique smoothest invariant manifold tangent to the unstable subspace of the upper branch. This invariant manifold leads to the limit cycle and coincides with the slowest (least stable) spectral submanifold of the limit cycle. We choose to parametrize this manifold using two of the physically observable quantities, the square root of the energy input rate $J=\sqrt{|I|}$ and that of the energy dissipation rate $K=\sqrt{|D|}$, where $I$ and $D$ are defined as

$$
\begin{array}{l}
I=\frac{1}{2L_x L_z }\int_0^{L_x } \int_0^{L_z } \left({\frac{\partial u}{\partial y}\left|\right.}_{y=1} +{\frac{\partial u}{\partial y}\left|\right.}_{y=-1} \right)~\textrm{d}z~\textrm{d}x-1,\\
D=\frac{1}{2L_x L_z }\int_0^{L_x } \int_{-1}^1 \int_0^{L_z } |\nabla \times u|^2 ~\textrm{d}z~\textrm{d}y~\textrm{d}x-1.
\end{array}
$$

With theses definitions, the rate of energy input $I$ and the energy dissipation are equal to zero at the laminar base state. The use the square roots $\left(J,K\right)$ of $\left(I,D\right)$ as parametrizing coordiates of the SSM is motivated in the other live scripts of this example. To describe the limit cycle with an extended normal form, we center $\left(J,K\right)$ on the upper state in this example. The calculation of the reduced order model and the parametrization are both carried out using SSMLearn [6]. We also note that in this data set the velocities are stored as centered at the laminar base state, hence the PCA reconstruction returns $\tilde{\mathbf{u}} \left(\mathit{\mathbf{x}},t\right)=\mathbf{u}\left(\mathit{\mathbf{x}},t\right)-\left(y,0,0\right)$.

[1] J. Page \& R. R. Kerswell, Koopman mode expansions between simple invariant solutions, *Journal of Fluid Mechanics* **879**, 1-27 (2019) 

[2] J. F. Gibson, J. Halcrow \& P. Cvitanović, Visualizing the geometry of state space in plane Couette flow, *Journal of Fluid Mechanics*, **611**, 107–130, (2008)

[3] B. Kaszás, M. Cenedese \& G. Haller, Modeling transitions between exact coherent states in plane Couette flow, *submitted, *(2022)

[4] J. F. Gibson, Channelflow: A spectral Navier-Stokes simulator in C++, Tech. Rep. (U. New Hampshire, 2014) `Channelflow.org`.

[5] G. Haller \& S. Ponsioen, Exact model reduction by a slow-fast decomposition of nonlinear mechanical systems. *Nonlinear Dynamics ***90, **617-647, (2017) 

[6] M. Cenedese, J. Axås, B. Bäuerlein, K. Avila \& G. Haller, Data-driven modeling and prediction of non-linearizable dynamics via spectral submanifolds *Nat. Commun*. **13** 872.  (2022) 

  
## Reading the data

We use 8 total trajectories. One of them starts very close to the unstable upper branch, in its unstable manifold. Over time this trajectory spirals outward on the unstable manifold and converges to the stable limit cycle. This trajectory will be used as training data. The remaining 7 trajectories start farther away from the unstable upper branch and will be used for testing. 

The cells xData contain the time and the $\left(I,D\right)$ reduced coordinates for these trajectories. 

The cell aData contains a compressed representation of the full flow field. We compressed the trajectories with PCA to reduce the size of the dataset. 

```matlab:Code
clearvars
close all
clc
load dataRe146

% Read the reduced coordinates, the PCA compressed velocity fields as a
% cell-type array suitable for SSMLearn
nTest = 7;
nTrain = 1;

% Visualize the training trajectories
customFigure('subPlot',[2 1],'latex', true);
subplot(211);
title('Training trajectories') 
plot(xData{1,1}, xData{1,2}(1,:), '-', 'Linewidth', 0.9);
xlabel('$t$', 'Interpreter','latex');
ylabel('$I$', 'Interpreter','latex');
 
subplot(212);
plot(xData{1,2}(1,:), xData{1,2}(2,:));
xlabel('$I$', 'Interpreter','latex');
ylabel('$D$', 'Interpreter','latex');
```

![figure_0.png
](README_images/figure_0.png
)

```matlab:Code
% Visualize the testing trajectories   
customFigure('latex', true); colororder(parula(nTest))
title('Test trajectories') 
hold on;
for iTraj = 1:nTest
    testIndex = indTest(iTraj);
    plot(xData{testIndex,1}, xData{testIndex,2}(1,:), '-', 'Linewidth', 1.2);
end
xlabel('$t$', 'Interpreter','latex');
ylabel('$I$', 'Interpreter','latex');
```

![figure_1.png
](README_images/figure_1.png
)

# Pre-processing

We apply the same cutting and centering tour trajectory data. We also save the variables $\left(J,K\right)$ into the cell array yDataTrunc.

```matlab:Code
% Cut the data and center it
nTraj = size(xData,1);
iniTime = 3500; endTime = 7000;
yDataTrunc = xData; aDataTrunc = aData; IDtoJK = @(x) sqrt(x); JKtoID = @(x) x.^2;
% We shift everything such that UB is at (0, 0).
xShift = xData{1,2}(:,1); % this are the I, D coordinates of the upper branch
aShift = -pcaComponents*transpose(pcaMean); % these are the PCA coordinates of the upper branch
% Train data
for iTraj = 1:nTrain
    t = xData{iTraj,1}; idxMin = sum(t<iniTime)+1; idxMax = sum(t<endTime)+1;
    yDataTrunc{iTraj,1} = xData{iTraj,1}(idxMin:idxMax);
    yDataTrunc{iTraj,2} = IDtoJK(xData{iTraj,2}(:,idxMin:idxMax)) - IDtoJK(xShift);
    aDataTrunc{iTraj,1} = aData{iTraj,1}(idxMin:idxMax);
    aDataTrunc{iTraj,2} = aData{iTraj,2}(:,idxMin:idxMax) - aShift;
end
iniTime = 100; endTime = 3000;
% Test data
for iTraj = 1:nTest
    idx = iTraj + nTrain;
    t = xData{idx,1}; idxMin = sum(t<iniTime)+1; idxMax = sum(t<endTime)+1;
     yDataTrunc{idx,1} = xData{idx,1}(idxMin:idxMax);
     yDataTrunc{idx,2} = IDtoJK(xData{idx,2}(:,idxMin:idxMax)) - IDtoJK(xShift);
     aDataTrunc{idx,1} = aData{idx,1}(idxMin:idxMax);
     aDataTrunc{idx,2} = aData{idx,2}(:,idxMin:idxMax) - aShift;
end
```

# Fitting the dynamics

To describe the transition from the upper branch to the limit cycle we aim for a normal form style model. In this case, the normal form is a simple, sparse representation of the dynamics whose structure is 

$\dot{\rho} =c(\rho )\rho ,~~~~\dot{\theta} =\omega (\rho ),~~~~$where ${c(\rho )=\sum_{j=0}^M c_j \rho^{2j} }$ and ${\omega (\rho )=\sum_{j=0}^M \omega_j \rho^{2j} }$

The polar coordinates $\left(\rho ,\theta \right)$ are linked to $\left(J,K\right)$ via a nonlinear change of coordinates, expressed in polynomial form. Both the coefficients of the dynamics and those of the coordinate transformation are found from data by the function `IMDynamicsFlow`.

```matlab:Code
orderNormalForm = 5;
RDInfo = IMDynamicsFlow(yDataTrunc(indTrain,:),'R_PolyOrd', orderNormalForm, 'style','normalform');
```

```text:Output
Estimation of the reduced dynamics...  Done. 
Estimation of the reduced dynamics in normal form...
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
     0           1      9.57935e-05                       0.00061
     1           4      6.67368e-05             91       0.000148  
     2           5      6.05364e-05              1       0.000121  
     3           6      4.70956e-05              1       0.000147  
     4           7      3.84519e-05              1       0.000127  
     5           8      3.56739e-05              1        8.2e-05  
     6           9        3.195e-05              1       7.55e-05  
     7          10      2.64158e-05              1       7.53e-05  
     8          11      1.93114e-05              1       0.000103  
     9          12      1.25719e-05              1       9.86e-05  
    10          13      1.13459e-05              1       8.77e-05  
    11          14      9.64018e-06              1       6.81e-05  
    12          15      6.17491e-06              1       2.35e-05  
    13          16      5.86254e-06              1       2.28e-05  
    14          17      5.50039e-06              1       2.36e-05  
    15          18      4.59182e-06              1       3.77e-05  
    16          19      3.40174e-06              1       4.33e-05  
    17          20       2.1557e-06              1       3.12e-05  
    18          21      1.71458e-06              1       2.29e-05  
    19          22      1.58135e-06              1       2.07e-05  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
    20          23      1.41647e-06              1       1.25e-05  
    21          24      1.29219e-06              1       6.91e-06  
    22          25      1.22873e-06              1       6.48e-06  
    23          26      1.19748e-06              1       6.75e-06  
    24          27      1.15003e-06              1       7.57e-06  
    25          28      1.05148e-06              1       7.53e-06  
    26          29      8.79425e-07              1        8.8e-06  
    27          30      6.89995e-07              1       8.21e-06  
    28          31       5.9047e-07              1       6.79e-06  
    29          32      5.59171e-07              1       5.85e-06  
    30          33       5.3761e-07              1       4.86e-06  
    31          34      4.93113e-07              1       4.97e-06  
    32          35      4.07281e-07              1       6.37e-06  
    33          36       2.8306e-07              1       8.01e-06  
    34          37      1.83292e-07              1       7.18e-06  
    35          38      1.43139e-07              1       4.74e-06  
    36          39      1.32545e-07              1       2.87e-06  
    37          40      1.25667e-07              1       2.71e-06  
    38          41      1.16246e-07              1       1.83e-06  
    39          42       1.0933e-07              1       2.76e-06  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
    40          43      1.05064e-07              1       3.18e-06  
    41          44      1.01139e-07              1       2.92e-06  
    42          45      9.45818e-08              1       2.11e-06  
    43          46      8.55327e-08              1       1.91e-06  
    44          47      7.82499e-08              1       1.23e-06  
    45          48       7.5778e-08              1       5.82e-07  
    46          49       7.5421e-08              1       5.28e-07  
    47          50      7.53066e-08              1       5.04e-07  
    48          51       7.4998e-08              1       4.49e-07  
    49          52      7.43702e-08              1       4.87e-07  
    50          53      7.31735e-08              1       6.87e-07  
    51          54      7.17548e-08              1       6.37e-07  
    52          55      7.08903e-08              1       3.15e-07  
    53          56      7.06483e-08              1       2.72e-07  
    54          57        7.056e-08              1       2.39e-07  
    55          58      7.03998e-08              1       2.47e-07  
    56          59      7.00287e-08              1        3.8e-07  
    57          60      6.92685e-08              1       5.61e-07  
    58          61      6.81271e-08              1       6.09e-07  
    59          62      6.71513e-08              1       5.76e-07  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
    60          63      6.67551e-08              1       5.72e-07  
    61          64      6.66337e-08              1       5.08e-07  
    62          65      6.65101e-08              1       4.33e-07  
    63          66      6.62162e-08              1       2.94e-07  
    64          67      6.56708e-08              1       4.16e-07  
    65          68      6.49279e-08              1       4.12e-07  
    66          69      6.43983e-08              1       2.69e-07  
    67          70      6.42091e-08              1       2.61e-07  
    68          71      6.41338e-08              1       2.91e-07  
    69          72      6.40125e-08              1       3.11e-07  
    70          73      6.37222e-08              1       3.25e-07  
    71          74      6.31068e-08              1       4.32e-07  
    72          75      6.20977e-08              1       5.05e-07  
    73          76        6.113e-08              1       3.63e-07  
    74          77      6.07232e-08              1       2.01e-07  
    75          78      6.06529e-08              1       1.95e-07  
    76          79      6.06343e-08              1       1.89e-07  
    77          80      6.05933e-08              1       1.78e-07  
    78          81      6.04919e-08              1       1.59e-07  
    79          82      6.02359e-08              1       2.04e-07  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
    80          83      5.96442e-08              1       3.33e-07  
    81          84      5.84884e-08              1        4.6e-07  
    82          85       5.6938e-08              1       4.68e-07  
    83          86      5.58661e-08              1       2.94e-07  
    84          87      5.55659e-08              1       2.17e-07  
    85          88      5.55167e-08              1       2.34e-07  
    86          89      5.54805e-08              1       2.37e-07  
    87          90      5.53711e-08              1       2.36e-07  
    88          91       5.5126e-08              1       2.25e-07  
    89          92      5.45721e-08              1       1.88e-07  
    90          93      5.36406e-08              1       2.62e-07  
    91          94      5.26689e-08              1        2.5e-07  
    92          95      5.22126e-08              1       1.67e-07  
    93          96       5.2124e-08              1       1.65e-07  
    94          97      5.21021e-08              1       1.59e-07  
    95          98        5.206e-08              1       1.51e-07  
    96          99      5.19515e-08              1       1.38e-07  
    97         100      5.16726e-08              1       1.35e-07  
    98         101       5.0974e-08              1       1.69e-07  
    99         102      4.93423e-08              1       2.95e-07  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   100         103      4.61194e-08              1       4.21e-07  
   101         104      4.17048e-08              1       4.25e-07  
   102         105       3.8588e-08              1       2.38e-07  
   103         106      3.77364e-08              1        8.5e-08  
   104         107      3.76586e-08              1       8.31e-08  
   105         108      3.76523e-08              1        8.3e-08  
   106         109       3.7643e-08              1       8.29e-08  
   107         110      3.76162e-08              1       8.33e-08  
   108         111      3.75531e-08              1       8.46e-08  
   109         112      3.74088e-08              1       8.86e-08  
   110         113      3.71483e-08              1       9.73e-08  
   111         114      3.68419e-08              1       1.19e-07  
   112         115      3.66671e-08              1       1.63e-07  
   113         116      3.66234e-08              1       1.68e-07  
   114         117      3.66106e-08              1       1.62e-07  
   115         118       3.6588e-08              1       1.53e-07  
   116         119      3.65303e-08              1       1.36e-07  
   117         120      3.63891e-08              1       1.04e-07  
   118         121        3.607e-08              1       8.23e-08  
   119         122      3.54896e-08              1       7.16e-08  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   120         123      3.48084e-08              1       1.32e-07  
   121         124      3.44253e-08              1        1.7e-07  
   122         125      3.43381e-08              1       1.72e-07  
   123         126      3.43213e-08              1       1.67e-07  
   124         127      3.42999e-08              1       1.61e-07  
   125         128      3.42402e-08              1       1.48e-07  
   126         129      3.40996e-08              1       1.31e-07  
   127         130       3.3781e-08              1       1.07e-07  
   128         131      3.32197e-08              1          1e-07  
   129         132      3.25952e-08              1       9.93e-08  
   130         133      3.22773e-08              1       4.64e-08  
   131         134      3.22186e-08              1       4.64e-08  
   132         135       3.2214e-08              1       4.74e-08  
   133         136      3.22122e-08              1       4.73e-08  
   134         137       3.2205e-08              1       4.71e-08  
   135         138      3.21889e-08              1       4.78e-08  
   136         139      3.21442e-08              1       4.89e-08  
   137         140      3.20315e-08              1       5.03e-08  
   138         141      3.17435e-08              1       7.67e-08  
   139         142      3.10542e-08              1       1.19e-07  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   140         143      2.95954e-08              1       1.88e-07  
   141         144       2.7285e-08              1       3.58e-07  
   142         145      2.51775e-08              1       5.11e-07  
   143         146      2.43278e-08              1       5.43e-07  
   144         147      2.41561e-08              1       5.17e-07  
   145         148      2.40718e-08              1       4.96e-07  
   146         149      2.38435e-08              1        4.5e-07  
   147         150      2.33246e-08              1       3.73e-07  
   148         151      2.21383e-08              1       2.37e-07  
   149         152      2.00721e-08              1       1.58e-07  
   150         153      1.78007e-08              1       9.34e-08  
   151         154      1.66726e-08              1       8.83e-08  
   152         155      1.64739e-08              1       2.66e-08  
   153         156      1.64635e-08              1       2.59e-08  
   154         157      1.64632e-08              1       2.59e-08  
   155         158       1.6463e-08              1       2.59e-08  
   156         159      1.64621e-08              1        2.6e-08  
   157         160        1.646e-08              1       2.61e-08  
   158         161      1.64542e-08              1       2.63e-08  
   159         162      1.64398e-08              1       2.65e-08  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   160         163      1.64039e-08              1       3.54e-08  
   161         164      1.63235e-08              1       5.23e-08  
   162         165      1.61779e-08              1       6.37e-08  
   163         166      1.60093e-08              1          8e-08  
   164         167      1.59157e-08              1       9.76e-08  
   165         168      1.58952e-08              1       9.64e-08  
   166         169      1.58915e-08              1       9.32e-08  
   167         170       1.5887e-08              1          9e-08  
   168         171      1.58739e-08              1       8.37e-08  
   169         172      1.58416e-08              1       7.38e-08  
   170         173      1.57584e-08              1       5.67e-08  
   171         174      1.55595e-08              1       5.21e-08  
   172         175      1.51382e-08              1       7.25e-08  
   173         176      1.44737e-08              1       7.81e-08  
   174         177      1.38733e-08              1       5.18e-08  
   175         178      1.36441e-08              1       2.18e-08  
   176         179      1.36157e-08              1       1.43e-08  
   177         180      1.36147e-08              1        1.4e-08  
   178         181      1.36146e-08              1        1.4e-08  
   179         182      1.36143e-08              1       1.39e-08  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   180         183      1.36137e-08              1       1.38e-08  
   181         184       1.3612e-08              1       1.36e-08  
   182         185      1.36076e-08              1       1.33e-08  
   183         186       1.3596e-08              1       1.48e-08  
   184         187      1.35661e-08              1       2.49e-08  
   185         188      1.34898e-08              1       4.05e-08  
   186         189      1.33039e-08              1       6.29e-08  
   187         190      1.28969e-08              1       8.85e-08  
   188         191      1.22036e-08              1       9.87e-08  
   189         192      1.14886e-08              1        6.8e-08  
   190         193      1.11594e-08              1       5.32e-08  
   191         194      1.11056e-08              1       5.45e-08  
   192         195      1.11022e-08              1       5.35e-08  
   193         196      1.11011e-08              1       5.31e-08  
   194         197      1.10967e-08              1       5.18e-08  
   195         198      1.10872e-08              1          5e-08  
   196         199      1.10611e-08              1       4.66e-08  
   197         200      1.09993e-08              1       4.07e-08  
   198         201      1.08631e-08              1       3.11e-08  
   199         202      1.06335e-08              1       2.67e-08  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   200         203      1.03996e-08              1       3.02e-08  
   201         204       1.0295e-08              1       3.44e-08  
   202         205      1.02787e-08              1       3.07e-08  
   203         206      1.02776e-08              1       2.89e-08  
   204         207      1.02772e-08              1       2.83e-08  
   205         208      1.02756e-08              1       2.67e-08  
   206         209      1.02721e-08              1       2.43e-08  
   207         210      1.02626e-08              1       2.31e-08  
   208         211      1.02406e-08              1       2.35e-08  
   209         212      1.01949e-08              1       2.13e-08  
   210         213      1.01268e-08              1       1.41e-08  
   211         214      1.00709e-08              1       1.14e-08  
   212         215      1.00525e-08              1       9.02e-09  
   213         216      1.00505e-08              1       9.15e-09  
   214         217      1.00504e-08              1       9.18e-09  
   215         218      1.00503e-08              1       9.18e-09  
   216         219      1.00501e-08              1        9.2e-09  
   217         220      1.00497e-08              1       9.23e-09  
   218         221      1.00484e-08              1       9.28e-09  
   219         222      1.00451e-08              1       9.35e-09  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   220         223      1.00365e-08              1       9.47e-09  
   221         224      1.00142e-08              1       1.12e-08  
   222         225      9.95661e-09              1       1.93e-08  
   223         226      9.81197e-09              1       3.15e-08  
   224         227      9.47105e-09              1       4.77e-08  
   225         228      8.78369e-09              1       6.24e-08  
   226         229      7.80034e-09              1       5.99e-08  
   227         230      7.05425e-09              1        3.2e-08  
   228         231      6.83207e-09              1        3.7e-08  
   229         232      6.81065e-09              1       3.67e-08  
   230         233      6.80978e-09              1       3.63e-08  
   231         234      6.80942e-09              1       3.62e-08  
   232         235      6.80764e-09              1       3.57e-08  
   233         236      6.80383e-09              1       3.51e-08  
   234         237      6.79307e-09              1       3.39e-08  
   235         238      6.76603e-09              1       3.19e-08  
   236         239      6.69649e-09              1       2.83e-08  
   237         240      6.52847e-09              1        2.2e-08  
   238         241      6.16438e-09              1       2.59e-08  
   239         242       5.5601e-09              1       2.88e-08  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   240         243      4.96553e-09              1       2.06e-08  
   241         244      4.71252e-09              1       7.63e-09  
   242         245      4.67603e-09              1       5.12e-09  
   243         246      4.67447e-09              1       5.02e-09  
   244         247      4.67444e-09              1       5.01e-09  
   245         248      4.67443e-09              1       5.01e-09  
   246         249      4.67437e-09              1          5e-09  
   247         250      4.67426e-09              1       4.98e-09  
   248         251      4.67392e-09              1       4.93e-09  
   249         252      4.67307e-09              1       4.84e-09  
   250         253      4.67086e-09              1       4.64e-09  
   251         254      4.66529e-09              1       4.18e-09  
   252         255      4.65196e-09              1       3.33e-09  
   253         256      4.62426e-09              1       4.21e-09  
   254         257      4.58198e-09              1       4.36e-09  
   255         258      4.54629e-09              1       4.42e-09  
   256         259      4.53401e-09              1       4.79e-09  
   257         260      4.53261e-09              1       4.28e-09  
   258         261      4.53256e-09              1        4.1e-09  
   259         262      4.53255e-09              1       4.08e-09  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   260         263      4.53254e-09              1       4.02e-09  
   261         264       4.5325e-09              1       3.94e-09  
   262         265       4.5324e-09              1       3.79e-09  
   263         266      4.53215e-09              1       3.55e-09  
   264         267       4.5315e-09              1       3.15e-09  
   265         268      4.52982e-09              1        3.2e-09  
   266         269      4.52559e-09              1       4.96e-09  
   267         270      4.51563e-09              1       7.34e-09  
   268         271      4.49555e-09              1       9.52e-09  
   269         272       4.4669e-09              1       9.28e-09  
   270         273      4.44524e-09              1       5.43e-09  
   271         274       4.4388e-09              1       1.48e-09  
   272         275      4.43819e-09              1       9.77e-10  
   273         276      4.43817e-09              1       9.72e-10  
   274         277      4.43817e-09              1       9.72e-10  
   275         278      4.43817e-09              1       9.71e-10  
   276         279      4.43817e-09              1        9.7e-10  
   277         280      4.43817e-09              1       9.69e-10  
   278         281      4.43816e-09              1       9.66e-10  
   279         282      4.43813e-09              1       9.61e-10  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   280         283      4.43806e-09              1       9.52e-10  
   281         284      4.43789e-09              1       9.34e-10  
   282         285      4.43744e-09              1       9.04e-10  
   283         286       4.4363e-09              1       1.48e-09  
   284         287      4.43354e-09              1        2.3e-09  
   285         288      4.42764e-09              1        3.2e-09  
   286         289      4.41806e-09              1       3.52e-09  
   287         290      4.40901e-09              1       2.42e-09  
   288         291      4.40538e-09              1       7.75e-10  
   289         292      4.40489e-09              1       7.44e-11  
   290         293      4.40487e-09              1        6.9e-11  
   291         294      4.40487e-09              1       6.86e-11  
   292         295      4.40487e-09              1       6.85e-11  
   293         296      4.40487e-09              1       6.84e-11  
   294         297      4.40487e-09              1       6.82e-11  
   295         298      4.40487e-09              1       6.79e-11  
   296         299      4.40487e-09              1       6.72e-11  
   297         300      4.40487e-09              1        6.6e-11  
   298         301      4.40487e-09              1       6.37e-11  
   299         302      4.40487e-09              1       5.93e-11  
                                                        First-order 
 Iteration  Func-count       f(x)        Step-size       optimality
   300         303      4.40487e-09              1        5.3e-11  
   301         304      4.40486e-09              1       7.81e-11  
   302         305      4.40486e-09              1       9.18e-11  
   303         306      4.40485e-09              1       6.97e-11  
   304         307      4.40484e-09              1       2.58e-11  
   305         308      4.40484e-09              1       4.41e-12  

Local minimum found.

Optimization completed because the size of the gradient is less than
the value of the optimality tolerance.

<stopping criteria details>
Plotting figure with the polar normal form equations ... Done. 
```

![figure_2.png
](README_images/figure_2.png
)

```matlab:Code
% Integrate all trajectories
yRec = advectRD(RDInfo, yDataTrunc);
format shortg; RDInfo.eigenvaluesLinPartFlow 
```

```text:Output
ans = 2x1 complex    
    0.0017137 +   0.092896i
    0.0017137 -   0.092896i

```

The eigenvalues from the reduced model match the full model's with remarkable accuracy. The eigenvalues can also be calculated with Channelflow, using an Arnoldi iteration. From the full model, we get $\lambda =0\ldotp 001696\pm 0\ldotp 092774\;i$.

```matlab:Code
errorsRDyn = computeTrajectoryErrors(yRec, yDataTrunc);
errorsTrain = errorsRDyn(indTrain)*100
```

```text:Output
errorsTrain = 
       5.7952

```

```matlab:Code
errorsTest = errorsRDyn(indTest)*100
```

```text:Output
errorsTest = 7x1    
       3.9085
       3.2783
       4.5108
       1.3881
       4.6367
       3.5753
       2.6436

```

# Display the trajectory predictions

```matlab:Code
% Plot the training trajectory and its reconstruction
customFigure('subPlot',[2 1],'latex', true); iTraj = 1;
subplot(211);
title('Train trajectories') 
plot(yDataTrunc{iTraj,1}, yDataTrunc{iTraj,2}(1,:), 'm', 'Linewidth', 2);
plot(yRec{iTraj,1},yRec{iTraj,2}(2,:),'k:','Linewidth',2)
xlabel('$t$', 'Interpreter','latex');
ylabel('$J$', 'Interpreter','latex');
legend('Trajectory','Reconstruction','location','SW')
subplot(212);
plot(yDataTrunc{iTraj,2}(1,:), yDataTrunc{iTraj,2}(2,:),'m','Linewidth',2);
plot(yRec{iTraj,2}(1,:),yRec{iTraj,2}(2,:),'k:','Linewidth',2)
xlabel('$J$', 'Interpreter','latex');
ylabel('$K$', 'Interpreter','latex');
```

![figure_3.png
](README_images/figure_3.png
)

```matlab:Code
% Plot the test trajectories and their reconstruction
customFigure('subPlot',[2 1],'latex', true); iTraj = 2;
subplot(211);
title('Test trajectory') 
plot(yDataTrunc{iTraj,1}, yDataTrunc{iTraj,2}(1,:), 'm', 'Linewidth', 2);
plot(yRec{iTraj,1},yRec{iTraj,2}(2,:),'k:','Linewidth',2)
xlabel('$t$', 'Interpreter','latex');
ylabel('$J$', 'Interpreter','latex');
legend('Trajectory','Reconstruction','location','SW')
subplot(212);
plot(yDataTrunc{iTraj,2}(1,:), yDataTrunc{iTraj,2}(2,:),'m','Linewidth',2);
plot(yRec{iTraj,2}(1,:),yRec{iTraj,2}(2,:),'k:','Linewidth',2)
xlabel('$J$', 'Interpreter','latex');
ylabel('$K$', 'Interpreter','latex');
```

![figure_4.png
](README_images/figure_4.png
)

# Fitting the parametrization

In this section, we parametrize the full flow, compressed in our data set in terms of PCA

$$
\tilde{u} \left(x,y,z\right)\approx {{\phi }}_0 \left(x,y,z\right)+\sum_{j=1}^N {{\phi }}_j \left(x,y,z\right)a_j (t)
$$

and we look for the parametrization

$a(t)=w(J(t),K(t))={\sum_{\left|l\right|=1}^M W_l {\left\lbrack \begin{array}{c}
J\left(t\right)\\
K\left(t\right)
\end{array}\right\rbrack }^l }$.

```matlab:Code
orderNormalForm = 5;
SSMDim = 2;
reducedCoordinateTransformation = @(x) x+IDtoJK(xShift);
IMInfo = IMGeometry(aDataTrunc(indTrain,:),SSMDim, orderNormalForm,'reducedCoordinates',funToCell(yDataTrunc(indTrain,:),reducedCoordinateTransformation));
```

```text:Output
Warning: Matrix is close to singular or badly scaled. Results may be inaccurate. RCOND =  2.225209e-18.
```

```matlab:Code
aRec = liftTrajectories(IMInfo, funToCell(yDataTrunc,reducedCoordinateTransformation)); 
```

We inspect the error made by the regression and we plot the manifold parametrization for a given PCA mode coordinate

```matlab:Code
errorsTest = computeTrajectoryErrors(aRec(indTest(1:4),:), aDataTrunc(indTest(1:4),:))*100
```

```text:Output
errorsTest = 4x1    
     0.013278
     0.013613
     0.014975
     0.013486

```

```matlab:Code
errorsTrain = computeTrajectoryErrors(aRec(indTrain,:), aDataTrunc(indTrain,:))*100
```

```text:Output
errorsTrain = 
     0.011101

```

```matlab:Code
% Create grid on the domain of interest and evaluate
[XoGrid,ThGrid] = meshgrid(linspace(0,1,21),linspace(0,2*pi,101)); modePlot = 3; iTraj = 1; 
IDDisp = 0.70711*[1 1; -1 1]*transpose([0.03*XoGrid(:).*cos(ThGrid(:)) 0.077*XoGrid(:).*sin(ThGrid(:))]) + xShift;
wSSM = IMInfo.parametrization.map;
JKDisp = IDtoJK(IDDisp);
aDisp = wSSM(JKDisp); aDisp = aDisp(modePlot,:);
% Surface plot
customFigure('latex',true);
h = surf(reshape(IDDisp(1,:),size(XoGrid)),...
         reshape(IDDisp(2,:),size(XoGrid)),...
         reshape(transpose(aDisp),size(XoGrid)),(XoGrid).^2);
h.EdgeColor = 'none'; h.FaceAlpha = .5; view(-77,35)
colormap cool
plot3((xData{iTraj,2}(1,:)),...
      (xData{iTraj,2}(2,:)),aData{iTraj,2}(modePlot,:)-aShift(modePlot),'k','Linewidth',1)
xlabel('$I$', 'Interpreter','latex');
ylabel('$D$', 'Interpreter','latex');
zlabel(['$a_{' num2str(modePlot) '}$'], 'Interpreter','latex');
```

![figure_5.png
](README_images/figure_5.png
)

```matlab:Code

% Surface plot
JKDisp = JKDisp - IDtoJK(xShift);
customFigure('latex',true);
h = surf(reshape(JKDisp(1,:),size(XoGrid)),...
         reshape(JKDisp(2,:),size(XoGrid)),...
         reshape(transpose(aDisp),size(XoGrid)),(XoGrid).^2);
h.EdgeColor = 'none'; h.FaceAlpha = .5; view(-77,35)
colormap cool
plot3(IDtoJK(xData{iTraj,2}(1,:)) - IDtoJK(xShift(1)),...
      IDtoJK(xData{iTraj,2}(2,:)) - IDtoJK(xShift(2)),aData{iTraj,2}(modePlot,:)-aShift(modePlot),'k','Linewidth',1)
xlabel('$J$', 'Interpreter','latex');
ylabel('$K$', 'Interpreter','latex');
zlabel(['$a_{' num2str(modePlot) '}$'], 'Interpreter','latex');
```

![figure_6.png
](README_images/figure_6.png
)

## Calculate the full reconstruction error

We take as initial data $\left(J,K\right)$, calculate the predicted time evolution then lift it back up to the full flow.

The error metric is 

$$
\textrm{Error}=||u(t)-u_{true} ||=\frac{1}{2L_x L_z }\int_0^{L_x } \int_{-1}^1 \int_0^{L_z } |u(t)-u_{\textrm{true}} (t)|
$$

in this compressed representation, we approximate the integral by the square sum of the entries in the vector. The relative error is the ratio between the error and the maximal norm of the true trajectory.

$$
\textrm{Rel.}\;\textrm{error}=||u(t)-u_{\textrm{true}} (t)||/\max \;||u_{\textrm{true}} (t)||
$$

```matlab:Code
customFigure('latex', true); 
for iTraj = indTest
    differenceTraj = aRec{iTraj, 2} - aDataTrunc{iTraj, 2}; 
    absError = sqrt(sum(differenceTraj.^2, 1)); % the absolute error is the square difference 
    toNorm = sqrt(max(sum(aDataTrunc{iTraj, 2}.^2, 1))); % calculate maximal value
    relError = (absError / toNorm) * 100; % display the error as a percentage
    plot(yDataTrunc{iTraj,1},relError,'-', 'Color', 'black','Linewidth',1)
end
set(gca, 'yscale', 'log');
xlabel('$t$', 'Interpreter','latex');
ylabel('Rel. error [$\%$]', 'Interpreter','latex');
```

![figure_7.png
](README_images/figure_7.png
)

## Recovering the full flowfields

Select the 4th test trajectory at t = 400. We will compare the predicted streamwise velocity fields at the centerline, $y=0$ to the truth. This snapshot is saved from the original simulation into the variable vx_test7_t273_validation or 

```matlab:Code
plotStreamwiseVelocityComparison(vx_test7_t273_validation,...
    aDataTrunc{indTest(7), 2}(:, 273-iniTime)+aShift,...
    aRec{indTest(7), 2}(:, 273-iniTime)+aShift,pcaComponents,pcaMean)
```

![figure_8.png
](README_images/figure_8.png
)
